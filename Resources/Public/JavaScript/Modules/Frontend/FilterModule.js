define(["TYPO3/CMS/In2studyfinder/Utility/UiUtility","TYPO3/CMS/In2studyfinder/Utility/UrlUtility","TYPO3/CMS/In2studyfinder/Utility/AjaxUtility"],function(d,c,e){"use strict";var f={identifiers:{in2studyfinderContainer:".in2studyfinder",filterForm:".js-in2studyfinder-filter",filterContainer:".js-in2studyfinder-filter-options",filterFieldset:".js-in2studyfinder-filter-section",filterLegend:".js-in2studyfinder-filter-legend",filterCheckbox:".in2studyfinder-js-checkbox",filterCheckboxAll:".in2studyfinder-js-checkbox-all",showFilterButton:".js-in2studyfinder-filter-button-show",hideFilterButton:".js-in2studyfinder-filter-button-reset",hideElement:".u-in2studyfinder-hide",isHidden:".is-hidden"},filter:[],initialize:function(){f.setEventListener(),f.prepareFilter()},prepareFilter:function(){f.prepareCheckboxes(),0<f.filter.length&&(f.toggleFilterVisibility(),f.filter.forEach(function(e){var t=document.querySelector('[data-filtergroup="'+e+'"]').querySelector(f.identifiers.filterContainer);d.toggleClassForElement(t,f.identifiers.isHidden.substr(1))}))},setEventListener:function(){document.querySelector(f.identifiers.hideFilterButton).addEventListener("click",f.resetAllFilter),document.querySelector(f.identifiers.showFilterButton).addEventListener("click",f.toggleFilterVisibility),f.setFilterVisibilityEventListener(),f.setFilterCheckboxEventListener()},setFilterCheckboxEventListener:function(){document.querySelector(".c-in2studyfinder-filter__sections").addEventListener("click",function(e){var t=e.target;if("INPUT"===t.tagName){if(t.classList.contains(f.identifiers.filterCheckboxAll.substr(1))){var i=t.parentNode;f.resetFilter(i)}if(t.classList.contains(f.identifiers.filterCheckbox.substr(1))){var r=t.parentNode.querySelector(f.identifiers.filterCheckboxAll);r.checked=!1,r.disabled=!1}f.updateFilter()}})},resetAllFilter:function(){if(0===f.filter.length)f.toggleFilterVisibility();else{var e=document.querySelectorAll(f.identifiers.filterContainer);f.toggleFilterVisibility();for(var t=0;t<e.length;t++)f.resetFilter(e[t]);f.updateFilter()}},resetFilter:function(e){var t=e.querySelector(f.identifiers.filterCheckboxAll),i=e.querySelectorAll(f.identifiers.filterCheckbox);t.checked=!0,t.disabled=!0,i.forEach(function(e){e.checked=!1});var r=f.filter.indexOf(e.parentNode.getAttribute("data-filtergroup"));-1!==r&&f.filter.splice(r,1)},updateFilter:function(){var e=document.querySelector(f.identifiers.in2studyfinderContainer),t=document.querySelector(f.identifiers.filterForm),i=e.getAttribute("data-plugin-uid"),r=e.getAttribute("data-in2studyfinder-language"),n="",l="";void 0!==i&&(n="&ce="+i),null!=r&&(l="&L="+r);var o="/?type=1308171055&studyFinderAjaxRequest=1"+n+l+"&tx_in2studyfinder_pi1[@widget_0][currentPage]=1",s=new XMLHttpRequest;s.onreadystatechange=function(){if(1===this.readyState&&d.enableLoader(),4===this.readyState&&200===this.status){var e=document.createElement("div");e.innerHTML=s.responseText,document.querySelector(f.identifiers.in2studyfinderContainer).parentNode.replaceChild(e.querySelector(f.identifiers.in2studyfinderContainer),document.querySelector(f.identifiers.in2studyfinderContainer)),require("TYPO3/CMS/In2studyfinder/Frontend").initialize(),d.disableLoader()}},s.open("POST",o,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(c.serialize(t))},setSelectedFilterToUrl:function(e){var t={},i="",r=document.querySelector(f.identifiers.filterForm).querySelectorAll(f.identifiers.filterCheckbox+":checked");r.forEach(function(e){console.log(e)}),console.log(r);var n=$(".js-in2studyfinder-filter").find("input.in2studyfinder-js-checkbox:checked");$(n).each(function(){var e=$(this).closest("fieldset").data("filtergroup");void 0===t[e]&&(t[e]=[]),t[e].push($(this).val())}),$(t).each(function(e,t){$.each(t,function(e,t){i+=e+"--",$.each(t,function(e,t){i+=t+"+"}),i=i.replace(/\+$/,""),i+="__"}),i=i.replace(/__$/,"")}),e&&(i+="page="+e),window.location=location.protocol+"//"+location.host+location.pathname+(location.search?location.search:"")+"#"+i},getSelectedFilterFromUrl:function(){var e=window.location.hash.split("#");if(1 in e){var t;if(-1!==(e=e[1]).indexOf("page=")&&(t=e.split("page=")[1],e=e.split("page=")[0]),""!==e){var i=e.split("__");$(i).each(function(e,t){var i=t.split("--"),r=t.substr(0,t.indexOf("--")),n=i[1].split("+");$(n).each(function(e,t){$("#"+r+"_"+t).prop("checked",!0)})})}return t}},setFilterVisibilityEventListener:function(){document.querySelectorAll(f.identifiers.filterFieldset).forEach(function(t){t.querySelector(f.identifiers.filterLegend).addEventListener("click",function(){var e=t.querySelector(f.identifiers.filterContainer);d.toggleClassForElement(e,f.identifiers.isHidden.substr(1))})})},toggleFilterVisibility:function(){document.querySelectorAll(f.identifiers.filterFieldset).forEach(function(e){d.toggleClassForElement(e,f.identifiers.hideElement.substr(1))});var e=document.querySelector(f.identifiers.showFilterButton),t=document.querySelector(f.identifiers.hideFilterButton);d.toggleClassForElement(e,f.identifiers.hideElement.substr(1)),d.toggleClassForElement(t,f.identifiers.hideElement.substr(1))},prepareCheckboxes:function(){document.querySelectorAll(f.identifiers.filterContainer).forEach(function(e){if(f.isFilterSet(e)){-1===f.filter.indexOf(e.parentNode.getAttribute("data-filtergroup"))&&f.filter.push(e.parentNode.getAttribute("data-filtergroup"));var t=e.querySelector(f.identifiers.filterCheckboxAll);t.checked=!1,t.disabled=!1}})},isFilterSet:function(e){var t=!1;return e.querySelectorAll(f.identifiers.filterCheckbox).forEach(function(e){e.checked&&(t=!0)}),t}};return f});